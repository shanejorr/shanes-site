---
title: Exploratory Analysis of North Carolina Traffic Stop Data
author: ''
date: '2021-02-17'
slug: exploratory-analysis-of-north-carolina-traffic-stop-data
categories:
  - eda
  - traffic stops
  - data visualization
tags: []
subtitle: 'Visualizing traffic stops in North Carolina'
summary: ''
authors: []
lastmod: '2021-02-17T19:08:49-05:00'
featured: no
image:
  caption: '<span>Photo by <a href="https://unsplash.com/@introspectivedsgn?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Erik Mclean</a> on <a href="https://unsplash.com/s/photos/police-car?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span>'
  focal_point: ''
  preview_only: no
projects: []
links:
- icon: github
  icon_pack: fab
  name: Github
  url: https://github.com/shanejorr/shanes-site/blob/main/content/post/2021-02-17-exploratory-analysis-of-north-carolina-traffic-stop-data/index.en.Rmd
  
draft: true
---

```{r setup, echo = F}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F,
                      error = F)
```

```{r importLibraries}
library(glue)
library(gt)
library(vroom)
library(tidycensus)
library(lubridate)
library(highcharter)
library(tidyverse)
```

```{r}
# create ggplot theme for this post
post_theme <- theme_minimal() +
  theme(legend.position = 'bottom',
        plot.title = element_text(size = 11),
        plot.subtitle = element_text(size = 10),
        axis.title = element_text(size = 10))

theme_set(post_theme)
```

```{r importData, eval = F, echo = F}
# city_dataset_links <- c(
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_charlotte_2020_04_01.csv.gz",
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_charlotte_2020_04_01.csv.gz",
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_fayetteville_2020_04_01.csv.gz",
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_greensboro_2020_04_01.csv.gz",
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_raleigh_2020_04_01.csv.gz",
# "https://shane-datasets.nyc3.digitaloceanspaces.com/traffic-stop/nc/nc_winston-salem_2020_04_01.csv.gz"
# )

nc_stops <- vroom('/home/shane/Documents/nc_statewide_2020_04_01.csv.zip',
                  col_select = -contains('raw'))

# nc_stops <- map_df(city_dataset_links, vroom, col_select = -contains('raw'))

nc_stops <- nc_stops %>%
  filter(date > '2005-01-01') %>%
  mutate(year = year(date)) %>%
  group_by(department_name, year) %>%
  sample_frac(.02) %>%
  ungroup()

write_rds(nc_stops, 'nc_stops.rds')
```


```{r}
nc_stops <- read_rds('nc_stops.rds')

nc_stops <- nc_stops %>%
  # remove string so that it matches with census data
  mutate(county_name = str_remove_all(county_name, ' County'),
         # rename misspelled county name
         county_name = str_replace_all(county_name, 'Tyrell', 'Tyrrell'))
  
```

```{r}
# census and shapefile information ----------------

# recode integers fo dates to years
recode_date <- c(
  `3` = 2010,
  `4` = 2011,
  `5` = 2012,
  `6` = 2013,
  `7` = 2014,
  `8` = 2015
)

# import population data by county and race
county_pop <- get_estimates(geography = "county", state = 'NC',
                            product = 'population', 
                            breakdown = 'RACE',
                            time_series = T,
                            year = 2018) %>%
  # only keep 2010 - 2015
  filter(DATE %in% seq(3, 8)) %>%
  # recode date
  mutate(DATE = recode(DATE, !!!recode_date)) %>%
  # remove string so that it matches with traffic stop data
  mutate(NAME = str_remove_all(NAME, ' County, North Carolina')) %>%
  # make density and population different columns
  pivot_wider(id_cols = c('NAME', 'DATE', 'GEOID'),
              names_from = 'variable', values_from = 'value')
```

## Number of stops per 100 residents

```{r}
# per capita number of stops ----------------

# calculate number of stops overall by year
per_capita_stops <- nc_stops %>%
  group_by(county_name, year) %>%
  filter(between(year, 2010, 2014), !is.na(county_name)) %>%
  count() %>%
  mutate(n = n / .02) %>% # delete
  arrange(year, desc(n)) %>%
  left_join(county_pop, 
            by = c('year' = 'DATE', 'county_name' = 'NAME')) %>%
  # calculate stops per 100 people
  mutate(stops_per = n/(POP/100))

# get most recent year
recent_year <- max(nc_stops$year)
```

### Counties with the most stops per 100 residents

```{r fig.width = 5, fig.height = 14}
# title and tooltip for stops per 100 plots
stops_per_title <-   "North Carolina Traffic Stops Per 100 Residents in 2014"
stops_per_tooltip <- "<b>{point.county_name}</b><br>Stops per 100 residents: <b>{point.stops_tooltip}</b>"

per_capita_stops_recent <- per_capita_stops %>%
  filter(year == !!recent_year) %>%
  # round stops in new column for tooltip
  mutate(stops_tooltip = round(stops_per, 1))

per_capita_stops_recent %>%
  arrange(desc(stops_per)) %>%
  hchart(., "bar", hcaes(x = county_name, y = stops_per)) %>%
    hc_xAxis(labels = list(enabled = FALSE),
             title = list(text = 'North Carolina counties')) %>%
    hc_yAxis(title = list(text = "Stops per 100 residents")) %>%
    hc_tooltip(
      headerFormat = "",
      pointFormat = stops_per_tooltip
    ) %>%
  hc_title(text = stops_per_title) %>% 
  hc_subtitle(text = "Hover over bars to see county name")
```

### Map of stops per 100 residents

```{r}

# get geoJSON map data for NC counties
nc_mapdata <- get_data_from_map(download_map_data("countries/us/us-nc-all"))

hcmap(
  "countries/us/us-nc-all",
  data = per_capita_stops_recent,
  value = "stops_per",
  joinBy = c("fips", "GEOID"),
  dataLabels = list(enabled = FALSE),
  borderColor = "#FAFAFA",
  borderWidth = 0.1,
  tooltip = list(
      headerFormat = "",
      pointFormat = stops_per_tooltip
    )
  ) %>%
  hc_title(text = stops_per_title) %>% 
  hc_subtitle(text = "Hover over county to see county name and rate")
```

### Relationship between county population density and number of stops

```{r}
per_capita_stops_recent %>%
  mutate(density_tooltip = round(DENSITY, 0)) %>%
  hchart(., "scatter", hcaes(x = DENSITY, y = n)) %>%
  hc_xAxis(type = 'logarithmic') %>%
  hc_yAxis(type = 'logarithmic') %>%
  hc_tooltip(
      headerFormat = "",
      pointFormat = "<b>{point.county_name}</b><br># of Stops: <b>{point.n}</b><br>Density: <b>{point.density_tooltip}</b>"
    )
```

```{r}
ggplot(per_capita_stops_recent, aes(DENSITY, n)) +
  geom_point(color = single_plot_color) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(color = 'black', se = F) +
  labs(title = 'Relationship Between Traffic Stops and Pop. Density',
       subtitle = 'Each Dot is A North Carolina County',
       x = 'County population density',
       y = 'Number of traffic stops in 2014')
```

### Relationship between percentage majority and stops per 100

```{r}
county_pop_race <- get_estimates(geography = "county", state = 'NC',
                            product = 'characteristics', 
                            breakdown = 'RACE',
                            breakdown_labels = T,
                            time_series = T,
                            year = 2018) %>%
  # only keep 2014
  filter(DATE == 7) %>%
  # remove string so that it matches with traffic stop data
  mutate(NAME = str_remove_all(NAME, ' County, North Carolina'))
```

### Search Rates



### Hit Rates