---
title: Exploratory Analysis of North Carolina Traffic Stop Data
author: ''
date: '2021-02-17'
slug: exploratory-analysis-of-north-carolina-traffic-stop-data
categories:
  - eda
  - traffic stops
  - data visualization
tags: []
subtitle: 'Visualizing traffic stops in North Carolina'
summary: ''
authors: []
lastmod: '2021-02-17T19:08:49-05:00'
featured: no
image:
  caption: '<span>Photo by <a href="https://unsplash.com/@introspectivedsgn?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Erik Mclean</a> on <a href="https://unsplash.com/s/photos/police-car?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span>'
  focal_point: ''
  preview_only: no
projects: []
links:
- icon: github
  icon_pack: fab
  name: Github
  url: https://github.com/shanejorr/shanes-site/blob/main/content/post/2021-02-17-exploratory-analysis-of-north-carolina-traffic-stop-data/index.en.Rmd
  
draft: true
---

```{r setup, echo = F}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F,
                      error = F)
```

```{r importLibraries}
library(glue)
library(gt)
library(vroom)
library(tidycensus)
library(lubridate)
library(highcharter)
library(tidyverse)
```

```{r}
# create ggplot theme for this post
post_theme <- theme_minimal() +
  theme(legend.position = 'bottom',
        plot.title = element_text(size = 11),
        plot.subtitle = element_text(size = 10),
        axis.title = element_text(size = 10))

theme_set(post_theme)
```

```{r importData, eval = F, echo = F}
nc_stops <- vroom('/home/shane/Documents/nc_statewide_2020_04_01.csv.zip',
                  col_select = -contains('raw'))

nc_stops <- nc_stops %>%
  filter(str_detect(reason_for_stop, "^Speed")) %>%
  mutate(year = year(date)) %>%
  # only keep between years 2010 and 2013 
  # (2010 is first year of population data and 2013 is final full year of stop data)
  filter(between(year, 2010, 2013)) %>%
  group_by(department_name, year) %>%
  sample_frac(.5) %>%
  ungroup()

write_rds(nc_stops, 'nc_stops.rds')
```

```{r}
nc_stops <- read_rds('nc_stops.rds')

nc_stops <- nc_stops %>%
  # remove string so that it matches with census data
  mutate(county_name = str_remove_all(county_name, ' County'),
         # rename misspelled county name
         county_name = str_replace_all(county_name, 'Tyrell', 'Tyrrell'))
```

```{r}
# census and shapefile information ----------------

# recode integers fo dates to years
recode_date <- c(
  `3` = 2010,
  `4` = 2011,
  `5` = 2012,
  `6` = 2013,
  `7` = 2014,
  `8` = 2015
)

# import population data by county and race
county_pop <- get_estimates(geography = "county", state = 'NC',
                            product = 'population', 
                            breakdown = 'RACE',
                            time_series = T,
                            year = 2018) %>%
  # remove string so that it matches with census data
  # only keep 2010 - 2014
  filter(DATE %in% seq(3, 6)) %>%
  # remove string so that it matches with traffic stop data
  mutate(NAME = str_remove_all(NAME, ' County, North Carolina')) %>%
  # make density and population different columns
  pivot_wider(id_cols = c('NAME', 'DATE', 'GEOID'),
              names_from = 'variable', values_from = 'value') %>%
  # aggregate 2010 - 2014 so it can be merged with aggregated stop data
  # sum population so we can divide by total stops between 2010-2014
  group_by(NAME, GEOID) %>%
  summarize(POP = sum(POP),
            DENSITY = mean(DENSITY))

```

```{r}
# per capita number of stops ----------------

# calculate number of stops overall by year
per_capita_stops <- nc_stops %>%
  filter(!is.na(county_name)) %>%
  group_by(county_name) %>%
  count() %>%
  arrange(county_name) %>%
  left_join(county_pop, 
            by = c('county_name' = 'NAME')) %>%
  # calculate stops per 100 people
  mutate(stops_per = n/(POP/100)) %>%
  # round stops in new column for tooltip
  mutate(stops_tooltip = round(stops_per, 1))
```

## Counties with the most stops per 100 residents

```{r fig.width = 5, fig.height = 14}
# title and tooltip for stops per 100 plots
stops_per_title <-   "North Carolina Speeding Stops Per 100 Residents Per Year 2010 - 2013"
stops_per_tooltip <- "<b>{point.county_name}</b><br>Stops per 100 residents: <b>{point.stops_tooltip}</b>"

per_capita_stops %>%
  arrange(desc(stops_per)) %>%
  hchart(., "bar", hcaes(x = county_name, y = stops_per)) %>%
    hc_xAxis(labels = list(enabled = FALSE),
             title = list(text = 'North Carolina counties')) %>%
    hc_yAxis(title = list(text = "Stops per 100 residents")) %>%
    hc_tooltip(
      headerFormat = "",
      pointFormat = stops_per_tooltip
    ) %>%
  hc_title(text = stops_per_title) %>% 
  hc_subtitle(text = "Hover over bars to see county name")
```

### Map of stops per 100 residents

```{r}
# chloropath map of speeding stops per 100 residents by NC county
hcmap(
  "countries/us/us-nc-all",
  data = per_capita_stops,
  value = "stops_per",
  joinBy = c("fips", "GEOID"),
  dataLabels = list(enabled = FALSE),
  borderColor = "#FAFAFA",
  borderWidth = 0.1,
  tooltip = list(
      headerFormat = "",
      pointFormat = stops_per_tooltip
    )
  ) %>%
  hc_title(text = stops_per_title) %>% 
  hc_subtitle(text = "Hover over county to see county name and rate")
```

## Relationship between county population density and number of stops

```{r}
per_capita_stops %>%
  mutate(density_tooltip = round(DENSITY, 0)) %>%
  hchart(., "scatter", hcaes(x = DENSITY, y = stops_per)) %>%
    hc_xAxis(type = 'logarithmic') %>%
    hc_tooltip(
        headerFormat = "",
        pointFormat = "<b>{point.county_name}</b>
                      <br># of Stops: <b>{point.n}</b>
                      <br>Density: <b>{point.density_tooltip}</b>"
      ) %>%
    hc_title(text = "Relationship between county population density and per capita speeding stops") %>% 
    hc_subtitle(text = "Each dot is a North Carolina county | Data reflects 2010 - 2014") %>%
    hc_xAxis(title = list(text = 'County population density')) %>%
    hc_yAxis(title = list(text = "Number of speeding stops per 100 residents")) 
```

## Days with the highest number of stops

```{r}
# create dataset of daily aggregate number of of stops for all NC

# mark counties as interstate counties
# i_40 <- c('Haywood', 'Buncombe', 'McDowell', 'Burke', 'Catawba', 'Iredell', 'Davie', 'Forsyth', 'Guilford', 
#           'Alamance', 'Orange', 'Durham', 'Wake', 'Johnston', 'Sampson', 'Duplin', 'Pender', 'New Hanover')
# 
# i_95 <- c('Robeson', 'Cumberland', 'Harnett', 'Johnston', 'Wilson', 'Nash', 'Halifax', 'Northampton')

daily_stops <- nc_stops %>%
  filter(year == max(year)) %>%
  # get daily totals for each interstate group
  drop_na(date) %>%
  count(date) %>%
  # calculate percentage of total number of stops
  ungroup() %>%
  mutate(total_stops = sum(n),
         perc_total = n / total_stops) %>%
  arrange(date)

# create abbreviated month and day for tooltip
daily_stops$date_tooltip <- glue("{month.abb[month(daily_stops$date)]} {day(daily_stops$date)}, {year(daily_stops$date)}")
```

```{r}
# line plot of daily stops
hchart(daily_stops, 'line', hcaes(x = date, y = n)) %>% 
  hc_xAxis(type = "datetime") %>%
  hc_tooltip(
    headerFormat = "",
    pointFormat = "<b>{point.date_tooltip}</b>
                      <br>Number of stops: <b>{point.n}</b>"
  ) %>%
  hc_title(text = 'Number Of Speeding Stops Per Day in North Carolina - 2013') %>% 
  hc_yAxis(title = list(text = '# of stops')) %>%
  hc_xAxis(title = list(text = NULL)) %>%
  # add lines and bands for dates
  hc_xAxis(
    plotLines = list(
      list(label = list(text = "July 4th"), color = "#7F7F7F", width = 2, zIndex = 1,
           value = datetime_to_timestamp(as.Date('2013-07-04')), dashStyle = 'Dash'),
      list(label = list(text = "Christmas"), color = "#7F7F7F", width = 2, zIndex = 2,
           value = datetime_to_timestamp(as.Date('2013-12-25')), dashStyle = 'Dash'),
      list(label = list(text = "Labor Day"), color = "#7F7F7F", width = 2, zIndex = 3,
           value = datetime_to_timestamp(as.Date('2013-09-02')), dashStyle = 'Dash'),
      list(label = list(text = "Thanksgiving"), color = "#7F7F7F", width = 2, zIndex = 4,
           value = datetime_to_timestamp(as.Date('2013-11-28')), dashStyle = 'Dash'),
      list(label = list(text = "Memorial Day"), color = "#7F7F7F", width = 2, zIndex = 5,
           value = datetime_to_timestamp(as.Date('2013-05-27')), dashStyle = 'Dash')
    )
  )
```

## Relationship between percentage majority and stops per 100

```{r}
county_pop_race <- get_estimates(geography = "county", state = 'NC',
                            product = 'characteristics', 
                            breakdown = 'RACE',
                            breakdown_labels = T,
                            time_series = T,
                            year = 2018) %>%
  # only keep 2014
  filter(DATE == 7) %>%
  # remove string so that it matches with traffic stop data
  mutate(NAME = str_remove_all(NAME, ' County, North Carolina'))
```

### Search Rates

### Hit Rates
